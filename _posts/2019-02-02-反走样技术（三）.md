---
layout: post
title: "åèµ°æ ·æŠ€æœ¯ï¼ˆä¸‰ï¼‰"
subtitle: "SSAA & MSAA"
cover: "/assets/img/webgl/quaternion.jpg"
date:   2019-02-02
category: coding
tags: WebGL
author: xiaOp
comments: true
index: 74
---

å‰ä¸¤ç¯‡å…³äºå‡ ä½•åèµ°æ · MLAA/SMAA å’Œ FXAA éƒ½æ˜¯åŸºäº post-processing åå¤„ç†å®Œæˆçš„ã€‚
åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°†ä»‹ç» SSAA å’Œ MSAA è¿™ä¸¤ç§æ›´åŠ ä¾èµ– GPU å®ç°çš„åèµ°æ ·æŠ€æœ¯ã€‚

# SSAA

æ¥è‡ª [https://zhuanlan.zhihu.com/p/28800047](https://zhuanlan.zhihu.com/p/28800047)

**SSAAï¼ˆSupersampling Anti-Aliasingï¼‰**å¯ä»¥è¯´æ˜¯å›¾å½¢å­¦ä¸­æœ€ç®€å•ç²—æš´çš„åèµ°æ ·æ–¹æ³•ï¼Œä½†åŒæ—¶ä¹Ÿæœ€æœ‰æ•ˆï¼Œå®ƒå”¯ä¸€ä¹Ÿæ˜¯è‡´å‘½çš„ç¼ºç‚¹æ˜¯æ€§èƒ½å¤ªå·®ã€‚å¼€ç¯‡å·²ç»è¯´è¿‡ï¼Œä»»ä½•ç±»å‹çš„èµ°æ ·å½’æ ¹ç»“åº•éƒ½æ˜¯å› ä¸ºæ¬ é‡‡æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦**å¢åŠ é‡‡æ ·æ•°**ï¼Œå°±å¯ä»¥å‡è½»èµ°æ ·ç°è±¡ã€‚è¿™å°±æ˜¯ SSAAï¼Œæ‰€ä»¥ SSAA ç®€å•çš„æ¥è¯´å¯ä»¥åˆ†ä¸‰æ­¥ï¼š

ï¼ˆ1ï¼‰åœ¨ä¸€ä¸ªåƒç´ å†…å–è‹¥å¹²ä¸ªå­é‡‡æ ·ç‚¹<br />ï¼ˆ2ï¼‰å¯¹å­åƒç´ ç‚¹è¿›è¡Œé¢œè‰²è®¡ç®—ï¼ˆé‡‡æ ·ï¼‰<br />ï¼ˆ3ï¼‰æ ¹æ®å­åƒç´ çš„é¢œè‰²å’Œä½ç½®ï¼Œåˆ©ç”¨ä¸€ä¸ªç§°ä¹‹ä¸º resolve çš„åˆæˆé˜¶æ®µï¼Œè®¡ç®—å½“å‰åƒç´ çš„æœ€ç»ˆé¢œè‰²è¾“å‡º

ä¸åŒ SSAA æ–¹å¼åœ¨å­é‡‡æ ·ä½ç½®çš„é€‰å–å’Œæœ€ç»ˆ resolve ä½¿ç”¨çš„æ»¤æ³¢å™¨ä¸Šæœ‰æ‰€ä¸åŒï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„é‡‡æ ·æ¨¡æ¿ï¼ˆè§„åˆ™é‡‡æ ·ï¼Œæ—‹è½¬é‡‡æ ·ï¼Œéšæœºé‡‡æ ·ï¼ŒæŠ–åŠ¨é‡‡æ ·ç­‰ï¼‰æˆ–è€…ä¸åŒçš„æ»¤æ³¢å‡½æ•°ï¼ˆæ–¹æ³¢æ»¤æ³¢å™¨æˆ–è€…é«˜æ–¯æ»¤æ³¢å™¨ï¼‰ã€‚<br />SSAAÂ **åŒæ—¶æ˜¯å‡ ä½•åèµ°æ ·å’Œç€è‰²åèµ°æ ·æ–¹æ³•**ï¼Œå› ä¸ºå®ƒä¸ä½†å¢åŠ äº†å½“å‰å‡ ä½•è¦†ç›–å‡½æ•°ï¼ˆCoverageï¼‰çš„é‡‡æ ·ç‡ï¼Œä¹Ÿå¯¹æ¸²æŸ“æ–¹ç¨‹è¿›è¡Œäº†æ›´é«˜é¢‘ç‡çš„é‡‡æ ·ï¼ˆå•ç‹¬è®¡ç®—æ¯ä¸ªå­åƒç´ çš„é¢œè‰²ï¼‰ã€‚

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549248886029-e619c4b3-6ecf-483d-ae43-b313d528a652.png#align=left&display=inline&height=221&linkTarget=_blank&name=image.png&originHeight=284&originWidth=544&size=103972&width=424)

## WebGL å®ç°

æ¥è‡ª Three.jsï¼š[ğŸ”—](https://github.com/mrdoob/three.js/blob/master/examples/webgl_postprocessing_ssaa.html)
{% prism javascript linenos %}
composer = new THREE.EffectComposer( renderer );

ssaaRenderPass = new THREE.SSAARenderPass( scene, camera );
ssaaRenderPass.unbiased = false;
composer.addPass( ssaaRenderPass );

copyPass = new THREE.ShaderPass( THREE.CopyShader );
copyPass.renderToScreen = true;
composer.addPass( copyPass );
{% endprism %}

### é‡‡æ ·æ¨¡ç‰ˆ

è¿™é‡Œé€‰ç”¨äº†æŠ–åŠ¨é‡‡æ ·ä½œä¸ºé‡‡æ ·æ¨¡ç‰ˆï¼š[ğŸ”—](https://docs.microsoft.com/zh-cn/windows/desktop/api/d3d11/ne-d3d11-d3d11_standard_multisample_quality_levels)<br />![](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549249830252-47852bb3-ffed-4926-a887-73ebc0394a4c.png#align=left&display=inline&height=823&linkTarget=_blank&originHeight=823&originWidth=606&size=0&width=606)
{% prism javascript linenos %}
THREE.SSAARenderPass.JitterVectors = [
	[
		[ 0, 0 ]
	],
	[
		[ 4, 4 ], [ - 4, - 4 ]
	],
	[
		[ - 2, - 6 ], [ 6, - 2 ], [ - 6, 2 ], [ 2, 6 ]
	],
	[
		[ 1, - 3 ], [ - 1, 3 ], [ 5, 1 ], [ - 3, - 5 ],
		[ - 5, 5 ], [ - 7, - 1 ], [ 3, 7 ], [ 7, - 7 ]
	],
    ...
];
{% endprism %}

### å¤šæ¬¡æ¸²æŸ“

æœ‰äº†é‡‡æ ·æ¨¡ç‰ˆï¼Œå°±å¯ä»¥è¿›è¡Œå¤šæ¬¡é‡‡æ ·è®¡ç®—äº†ï¼Œè¿™é‡Œä½¿ç”¨åˆ°äº† [PerspectiveCamera.setViewOffset](https://threejs.org/docs/#api/en/cameras/PerspectiveCamera.setViewOffset)ï¼Œåœ¨æ¯ä¸€æ¬¡é‡‡æ ·è¿‡ç¨‹ä¸­æ”¹å˜åç§»é‡ï¼Œå½“ç„¶åˆ«å¿˜äº†å¾ªç¯ç»“æŸåé‡ç½®ï¼š
{% prism javascript linenos %}
for ( var i = 0; i < jitterOffsets.length; i ++ ) {
  var jitterOffset = jitterOffsets[ i ];

  if ( this.camera.setViewOffset ) {
    this.camera.setViewOffset( width, height,
      jitterOffset[ 0 ] * 0.0625, jitterOffset[ 1 ] * 0.0625,   // 0.0625 = 1 / 16
      width, height );
  }
  //...
}
// è®¡ç®—ç»“æŸåæ¸…é™¤åç§»é‡
if ( this.camera.clearViewOffset ) this.camera.clearViewOffset();
{% endprism %}

é‚£ä¹ˆå¤šæ¬¡é‡‡æ ·çš„æƒé‡æ˜¯å¦åº”è¯¥éƒ½ç›¸åŒå‘¢ï¼Ÿè¿™æ ·åªéœ€è¦ç®€å•å¹³å‡å¤šæ¬¡é‡‡æ ·çš„ç»“æœå°±å¯ä»¥äº†ã€‚
> the theory is that equal weights for each sample lead to an **accumulation of rounding errors**.Â The following equation varies the sampleWeight per sample so that it is uniformly distributed across a range of values whose rounding errors cancel each other out.

[https://en.wikipedia.org/wiki/Round-off_error#Accumulation_of_roundoff_error](https://en.wikipedia.org/wiki/Round-off_error#Accumulation_of_roundoff_error)
{% prism javascript linenos %}
var sampleWeight = baseSampleWeight; // 1 / jitterOffsets.length
if ( this.unbiased ) {
	var uniformCenteredDistribution = ( - 0.5 + ( i + 0.5 ) / jitterOffsets.length );
	sampleWeight += roundingRange * uniformCenteredDistribution;
}
{% endprism %}

æœ€åè¾“å‡ºåˆ°Â sampleRenderTarget ä¸­ä¾›ä¸‹ä¸€æ­¥æ··åˆä½¿ç”¨ï¼š
{% prism javascript linenos %}
renderer.setClearColor( this.clearColor, this.clearAlpha );
renderer.render( this.scene, this.camera, this.sampleRenderTarget, true );
{% endprism %}

### æ··åˆ

åœ¨æ··åˆåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªä½¿ç”¨æ­£äº¤æŠ•å½±çš„ç›¸æœºä»¥åŠä¾› CopyPass ä½¿ç”¨çš„ä¸€ä¸ªç®€å•å¹³é¢ï¼š
{% prism javascript linenos %}
this.camera2 = new THREE.OrthographicCamera( - 1, 1, 1, - 1, 0, 1 );
this.scene2	= new THREE.Scene();
this.quad2 = new THREE.Mesh( new THREE.PlaneBufferGeometry( 2, 2 ), this.copyMaterial );
this.quad2.frustumCulled = false; // Avoid getting clipped
this.scene2.add( this.quad2 );
{% endprism %}

åœ¨è´Ÿè´£æ‹·è´çš„åå¤„ç† Shader ä¸­ï¼Œblending: THREE.AdditiveBlendingÂ æ˜¯å…³é”®ï¼Œå› ä¸ºå¤šæ¬¡é‡‡æ ·ç»“æœéœ€è¦åŠ æƒå¹³å‡ï¼š
{% prism javascript linenos %}
this.copyMaterial = new THREE.ShaderMaterial({
		uniforms: this.copyUniforms,
		vertexShader: copyShader.vertexShader,
		fragmentShader: copyShader.fragmentShader,
		premultipliedAlpha: true,
		transparent: true,
		blending: THREE.AdditiveBlending, // ç´¯åŠ 
		depthTest: false,
		depthWrite: false
});
{% endprism %}

è¦ç‰¹åˆ«æ³¨æ„ç”±äºéœ€è¦è¿›è¡Œç´¯åŠ ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ¸²æŸ“éœ€è¦æ¸…ç©º color bufferï¼š
{% prism javascript linenos %}
// æ··åˆæƒé‡
this.copyUniforms[ "opacity" ].value = sampleWeight;
this.copyUniforms[ "tDiffuse" ].value = this.sampleRenderTarget.texture;
// åªæœ‰ç¬¬ä¸€æ¬¡æ¸²æŸ“éœ€è¦æ¸…ç©º
if ( i === 0 ) {
	renderer.setClearColor( 0x000000, 0.0 );
}
// æ··åˆ
renderer.render( this.scene2, this.camera2, this.renderToScreen ? null : writeBuffer, ( i === 0 ) );
{% endprism %}

## å®é™…æ•ˆæœ

æ€§èƒ½å¤ªå·®ï¼Œé‡‡æ ·ç‚¹å¢åŠ åˆ° 16 ä¸ªå°±å·²ç»å¡é¡¿ä¸¥é‡ã€‚å’Œæ‹¥æœ‰ç¡¬ä»¶æ”¯æŒçš„Â MSAA å®Œå…¨æ²¡å¾—æ¯”ï¼Œå³ä½¿å¯¹äºå‡ ä½•å’Œé¢œè‰²èµ°æ ·éƒ½æœ‰æ”¹å–„ã€‚


## MSAAï¼ˆMultisample Anti-Aliasingï¼‰

> SSAAä¸­æ¯ä¸ªåƒç´ éœ€è¦å¤šæ¬¡è®¡ç®—ç€è‰²ï¼Œè¿™å¯¹å®æ—¶æ¸²æŸ“çš„å¼€é”€æ˜¯å·¨å¤§çš„ï¼ˆæƒ³æƒ³4Kå’Œ1080Pçš„æ€§èƒ½å·®å¼‚ï¼‰ï¼Œæˆ‘ä»¬å¼€å§‹ä¹Ÿè¯´è¿‡ï¼Œå®é™…ä¸Š**äººçœ¼å¯¹å‡ ä½•èµ°æ ·æ›´æ•æ„Ÿ**ï¼Œèƒ½å¦è§£è€¦å‡ ä½•è¦†ç›–å‡½æ•°çš„é‡‡æ ·ç‡å’Œç€è‰²æ–¹ç¨‹çš„é‡‡æ ·ç‡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚MSAAçš„åŸç†å¾ˆç®€å•ï¼Œå®ƒä»ç„¶æŠŠä¸€ä¸ªåƒç´ åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªå­é‡‡æ ·ç‚¹ï¼Œä½†æ˜¯ç›¸è¾ƒäºSSAAï¼Œæ¯ä¸ªå­é‡‡æ ·ç‚¹çš„é¢œè‰²å€¼å®Œå…¨ä¾èµ–äºå¯¹åº”åƒç´ çš„é¢œè‰²å€¼è¿›è¡Œç®€å•çš„å¤åˆ¶ï¼ˆè¯¥å­é‡‡æ ·ç‚¹ä½äºå½“å‰åƒç´ å…‰æ …åŒ–ç»“æœçš„è¦†ç›–èŒƒå›´å†…ï¼‰ï¼Œä¸è¿›è¡Œå•ç‹¬è®¡ç®—ã€‚æ­¤å¤–å®ƒçš„åšæ³•å’ŒSSAAç›¸åŒï¼Œæ¯ä¸ªå­åƒç´ ä¼šåœ¨å…‰æ …åŒ–é˜¶æ®µåˆ†åˆ«è®¡ç®—è‡ªèº«çš„Zå€¼å’Œæ¨¡æ¿å€¼ï¼Œæœ‰å®Œæ•´çš„Z-Testå’ŒStencil-Testå¹¶å•ç‹¬ä¿å­˜åœ¨Z-Bufferå’ŒStencil-Bufferé‡Œï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„å‡ ä½•è¦†ç›–ä¿¡æ¯ã€‚ç±»ä¼¼äºSSAAï¼ŒMSAAä¹Ÿéœ€è¦ä¸€ä¸ªresolveçš„è¿‡ç¨‹ï¼Œåœ¨æ—©æœŸï¼ˆDX9/10?ï¼‰è¿™ä¸ªè¿‡ç¨‹æ˜¯æ˜¾å¡çš„ä¸€ä¸ªå›ºæœ‰å•å…ƒåœ¨æ‰§è¡Œï¼Œæ‰§è¡Œçš„æ–¹å¼ä¸€èˆ¬ä¹Ÿå°±æ˜¯ç®€å•çš„Box Filterï¼Œéšç€å¯ç¼–ç¨‹ç®¡çº¿çš„åŠŸèƒ½é€æ¸å¼ºå¤§ï¼Œç°åœ¨å¯ä»¥é€šè¿‡Pixel Shaderæ¥è®¿é—®ç›¸åº”çš„MSAA Textureï¼Œå¹¶ä¸”å®šåˆ¶resolveçš„ç®—æ³•ã€‚**ç”±äº MSAA æ‹¥æœ‰ç¡¬ä»¶æ”¯æŒï¼Œç›¸å¯¹å¼€é”€æ¯”è¾ƒå°ï¼Œåˆèƒ½å¾ˆå¥½åœ°è§£å†³å‡ ä½•èµ°æ ·é—®é¢˜ï¼Œåœ¨æ¸¸æˆä¸­åº”ç”¨éå¸¸å¹¿æ³›**ï¼ˆæˆ‘ä»¬åœ¨æ¸¸æˆç”»è´¨é€‰é¡¹ä¸­å¸¸çœ‹åˆ°çš„ 4x/8x/16x æŠ—é”¯é½¿ä¸€èˆ¬è¯´çš„å°±æ˜¯ MSAA çš„å­é‡‡æ ·ç‚¹æ•°é‡åˆ†åˆ«ä¸º4/8/16ä¸ªï¼‰ã€‚

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549209474206-9cc63a8f-5725-482e-816a-05d38a50ea91.png#align=left&display=inline&height=505&linkTarget=_blank&name=image.png&originHeight=651&originWidth=685&size=155702&width=531)
## WebGL å®ç°

### å†…ç½®å®ç°

[https://stackoverflow.com/questions/50255282/webgl2-has-anti-alias-automatically-built-in](https://stackoverflow.com/questions/50255282/webgl2-has-anti-alias-automatically-built-in)
> By setting it toÂ `false`Â you're telling the browser "Don't turn on antialiasing" period. For example if you're making a pixelated game you might want to tell the browser to not antialias.


<br />é¦–å…ˆå¼€å‘è€…å¯ä»¥å¼ºåˆ¶è®¾ç½®ä¸º falseï¼Œè¿™æ ·æµè§ˆå™¨ä¸€å®šä¸ä¼šåº”ç”¨ï¼Œåœ¨ä¸€äº›åƒç´ æ¸¸æˆåœºæ™¯ä¸‹å¸¸è§ã€‚åœ¨ FXAA/MLAA ç­‰ä½¿ç”¨åå¤„ç†è¿›è¡Œå‡ ä½•åèµ°æ ·çš„ä¾‹å­ä¸­ä¹Ÿä¼šæ‰‹åŠ¨å…³é—­ï¼Œä»¥ä¿è¯çœŸå®æ•ˆæœã€‚

ç„¶åå³ä½¿è®¾ç½®ä¸º trueï¼Œå®é™…æ˜¯å¦åº”ç”¨ MSAA/SSAA åèµ°æ ·è¿˜æ˜¯ç”±æµè§ˆå™¨å®ç°å†³å®šï¼Œè¿™ä¹Ÿæ˜¯è§„èŒƒè§„å®šçš„ï¼š
{% prism javascript linenos %}
const gl = canvas.getContext(webglVersion, {
	antialias: true
});
{% endprism %}

å› æ­¤ä¸ºäº†æµ‹è¯•åèµ°æ ·æ˜¯å¦ç”Ÿæ•ˆï¼Œå¯ä»¥ç”¨ä¸€æ®µç®€å•çš„æµ‹è¯•ä»£ç ï¼Œç”»ä¸€ä¸ªçº¢è‰²çš„ä¸‰è§’å½¢ï¼Œç„¶åæ£€æŸ¥å››ä¸ªç‚¹æ˜¯å¦åªæœ‰çº¢é»‘ä¸¤ç§é¢œè‰²ï¼Œå¦‚æœæ˜¯åˆ™è¯´æ˜æ²¡æœ‰è¿›è¡Œé¢œè‰²åèµ°æ ·ï¼š
{% prism javascript linenos %}
gl.drawArrays(gl.TRIANGLES, 0, 3);
const pixels = new Uint8Array(2 * 2 * 4);
gl.readPixels(0, 0, 2, 1, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
const isNotAntialiased = 
  isRedOrBlack(pixels[ 0]) && 
  isRedOrBlack(pixels[ 4]) && 
  isRedOrBlack(pixels[ 8]) && 
  isRedOrBlack(pixels[12]) ; 
{% endprism %}

çœ‹èµ·æ¥ WebGL å†…ç½®çš„åèµ°æ ·å®ç°å¼€å‘è€…å¹¶ä¸æ˜¯å®Œå…¨å¯æ§ã€‚

### WebGL2

WebGL2 çš„å®ç°å¯ä»¥å‚è€ƒï¼š
* [https://github.com/shrekshao/MoveWebGL1EngineToWebGL2/blob/master/Move-a-WebGL-1-Engine-To-WebGL-2-Blog-2.md#multisampled-renderbuffers](https://github.com/shrekshao/MoveWebGL1EngineToWebGL2/blob/master/Move-a-WebGL-1-Engine-To-WebGL-2-Blog-2.md#multisampled-renderbuffers)
* [http://webglsamples.org/WebGL2Samples/#fbo_multisample](http://webglsamples.org/WebGL2Samples/#fbo_multisample)

æ€»å…±éœ€è¦ä¸¤ä¸ª Passï¼Œç¬¬ä¸€ä¸ªç»˜åˆ¶åˆ°å¼€å¯äº† MSAA çš„ renderBuffer ä¸­ï¼Œç¬¬äºŒä¸ªé€šè¿‡åå¤„ç†è¯»å–çº¹ç†ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚
> pre-z pass --> rendering pass to FBO --> postprocessing pass --> render to window

<br />
#### 1st Passï¼šrenderBuffer

åœ¨è¿™ä¸ª Pass ä¸­ï¼Œéœ€è¦ä½¿ç”¨åˆ° WebGL2 ä¸­æ–°åŠ å…¥çš„ APIï¼š
* **`clearBuffer[fiuv]()`**Â [ğŸ”—](https://developer.mozilla.org/en-US/docs/Web/API/WebGL2RenderingContext/clearBuffer)
* **`renderbufferStorageMultisample(target, samples, internalFormat, width, height);`**

é¦–å…ˆç»‘å®š renderBuffer å¹¶åº”ç”¨ MSAAï¼Œä¸‹é¢çš„ä¾‹å­ä¸­å­é‡‡æ ·ç‚¹æ•°é‡ä¸º 4ï¼š
{% prism javascript linenos %}
var colorRenderbuffer = gl.createRenderbuffer();
gl.bindRenderbuffer(gl.RENDERBUFFER, colorRenderbuffer);
gl.renderbufferStorageMultisample(gl.RENDERBUFFER, 4, gl.RGBA8, FRAMEBUFFER_SIZE.x, FRAMEBUFFER_SIZE.y);

// ç»‘å®šåˆ° fbo
gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffers[FRAMEBUFFER.RENDERBUFFER]);
gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.RENDERBUFFER, colorRenderbuffer);
gl.bindFramebuffer(gl.FRAMEBUFFER, null);
{% endprism %}

ç„¶åå¼€å§‹ç»˜åˆ¶åˆ° renderBuffer ä¸­ï¼š
{% prism javascript linenos %}
gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffers[FRAMEBUFFER.RENDERBUFFER]);
// æ¸…é™¤ Color bufferï¼Œåºå·ä¸º 0ï¼Œæ¸…é™¤é¢œè‰²è®¾ç½®ä¸ºé»‘è‰²
gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 0.0, 1.0]);
gl.useProgram(programs[PROGRAM.TEXTURE]);
// åˆ‡æ¢ vao
gl.bindVertexArray(vertexArrays[PROGRAM.TEXTURE]);
// çœç•¥ä¼ å…¥ uniform
gl.drawArrays(gl.LINE_LOOP, 0, vertexCount);
{% endprism %}

æ¥ä¸‹æ¥å¦‚ä½•è¾“å‡ºåˆ° TEXTURE0 æ˜¯ä¸€ä¸ªé—®é¢˜ï¼ŒWebGL2 å¹¶æ²¡æœ‰æ”¯æŒ multisample çš„çº¹ç†ï¼š
> Pay attention to the fact that the multisample renderbuffersÂ **cannot be directly bound to textures**, but they can be resolved to single-sample textures using theÂ **blitFramebuffer**Â call

<br /><br />è¿™é‡Œå°±éœ€è¦ä½¿ç”¨Â WebGL2 ä¸­æ–°åŠ å…¥çš„å¦ä¸€ä¸ª APIï¼š**blitFramebuffer **äº†ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ä» readBuffer ä¼ é€’åƒç´ åˆ° writeBuffer ä¸­ï¼š
{% prism javascript linenos %}
// ç»‘å®šè¯»å†™ä¸¤ä¸ª buffer
gl.bindFramebuffer(gl.READ_FRAMEBUFFER, framebuffers[FRAMEBUFFER.RENDERBUFFER]);
gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, framebuffers[FRAMEBUFFER.COLORBUFFER]);
// æ¸…é™¤ COLORBUFFER
gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 0.0, 1.0]);
// å¼€å§‹ä¼ é€’ RENDERBUFFER åˆ° COLORBUFFER
gl.blitFramebuffer(
  0, 0, FRAMEBUFFER_SIZE.x, FRAMEBUFFER_SIZE.y,
  0, 0, FRAMEBUFFER_SIZE.x, FRAMEBUFFER_SIZE.y,
  gl.COLOR_BUFFER_BIT, gl.NEAREST
);
{% endprism %}

#### 2nd Passï¼šç»˜åˆ¶åˆ°å±å¹•

ç°åœ¨æˆ‘ä»¬ç»è¿‡ multisample çš„çº¹ç†å·²ç»åœ¨ TEXTURE0 ä¸­äº†ï¼š
{% prism javascript linenos %}
gl.bindFramebuffer(gl.FRAMEBUFFER, null);
gl.useProgram(programs[PROGRAM.SPLASH]);
gl.uniform1i(diffuseLocation, 0);
gl.activeTexture(gl.TEXTURE0);
gl.bindTexture(gl.TEXTURE_2D, texture);
gl.bindVertexArray(vertexArrays[PROGRAM.SPLASH]);
gl.clearColor(0.0, 0.0, 0.0, 1.0);
gl.clear(gl.COLOR_BUFFER_BIT);
{% endprism %}

å°±æ˜¯ä¸€ä¸ªåå¤„ç† CopyShader çš„å®ç°ï¼š
{% prism glsl linenos %}
#version 300 es
precision highp float;
precision highp int;
uniform sampler2D diffuse;
in vec2 uv;
out vec4 color;
void main()
{
	color = texture(diffuse, uv);
}
{% endprism %}

æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼Œå¯è§é¢œè‰²åèµ°æ ·æ•ˆæœå¾ˆæ˜æ˜¾ï¼š<br />![å±å¹•å¿«ç…§ 2019-02-04 ä¸Šåˆ10.37.09.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549247925408-33830c2a-b80a-48d8-b87b-0c83a8d49bd3.png#align=left&display=inline&height=628&linkTarget=_blank&name=%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-04%20%E4%B8%8A%E5%8D%8810.37.09.png&originHeight=1480&originWidth=1758&size=112430&width=746)

### Three.js å®ç°

Three.js åœ¨æœ€è¿‘çš„ä¸€æ¬¡ PR [https://github.com/mrdoob/three.js/pull/15541](https://github.com/mrdoob/three.js/pull/15541)Â ä¸­å¼•å…¥äº†è¿™ä¸ª WebGL2 ç‰¹æ€§ã€‚

ç”¨æ³•å¦‚ä¸‹Â [ğŸ”—](https://github.com/mrdoob/three.js/blob/master/examples/webgl2_multisampled_renderbuffers.html)
{% prism javascript linenos %}
var parameters = {
  format: THREE.RGBFormat,
  stencilBuffer: false
};
var size = renderer.getDrawingBufferSize();
var renderTarget = new THREE.WebGLMultisampleRenderTarget( size.width, size.height, parameters );
composer1 = new THREE.EffectComposer( renderer, renderTarget );
{% endprism %}


